---
title: "Bayesian_restriction"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The aim of this markdown file

This markdown highlights my problems when trying to implement restriction models for my contrasts. Below, I compare the examples even on the easy stats website (https://easystats.github.io/bayestestR/articles/bayes_factors.html#specifying-correct-priors-for-factors-with-more-than-2-levels) to my own examples.

My experiment involves a corrective steering task. Drivers are traveling down a simulated road line that is invisible. As the road line becomes visible, the driver's heading is offset (i.e. they are travelling away from the line). Their task is to steer back onto the line. The road line is presented for 2.5 seconds. For this example analysis, I am measuring drivers reaction time for steering onset (FirstSteeringTime). 

My hypothesis is that FirstSteeringTime will decreases as heading increases. 

## Load packages 

```{r load packages, message =FALSE}
library(dplyr) # data manipulation
library(tidyr) # data manipulation
library(ggplot2) # data vis
library(BayesFactor) # performs Bayesian ANOVA
library(rstanarm) # bayesian regression modelling
library(bayestestR) # describes Bayesian models and posterior distributions
library(bayesplot) # allows plots for posterior predictive distributions
library(loo) # Bayesian model comparison
library(arm) # computes Bayes factor for glm model
library(insight) # get posterior parameters 
library(fitdistrplus) # investigating the distribution of my data
library(see) # helps with plotting for bayestestR package
library(emmeans) # marginal mean function
```

## Load my data and data used in the example

```{r load my data}
# rm(list = ls()) - clear global environment
# home working directory
# setwd("C:/Users/Courtney/Documents/PhD/Project/Experiment_Code/experiment_1")
setwd("C:/Users/pscmgo/OneDrive for Business/PhD/Project/Experiment_Code/experiment_1")
temp = list.files(pattern = c("magnitudedata", "*.csv"))
myfiles = lapply(temp, read.csv)
magnitudedata <- do.call(rbind.data.frame, myfiles)
data("iris")
```

## Setting heading levels as factors and setting contrasts

```{r factors}
magnitudedata <- magnitudedata %>%
  dplyr::filter(heading > 0)

magnitudedata$heading <- as.factor(magnitudedata$heading)

```

Here I remove the 0 heading condition (this was a control condition in my experiment and I am not using it for analysis as subjects should not have made a steering adjustment). 

I also change my predictor variable to a factor. 

## Fitting Bayesian model for contr.sum contrasts

```{r contr.sum contrasts}
contrasts(magnitudedata$heading) <- "contr.sum"

fit_sum <- stan_glm(FirstSteeringTime ~ heading,
                       family = Gamma(link = "identity"),
                       adapt_delta = 0.999,
                       data = magnitudedata)

c_sum <- pairs(emmeans(fit_sum, ~ heading))
c_sum
```

## Fitting Bayesian model for contr.bayes contrasts

```{r contr.bayes contrasts}
contrasts(magnitudedata$heading) <- "contr.bayes"

fit_bayes <- stan_glm(FirstSteeringTime ~ heading, family = gaussian(), prior = cauchy(0.5, 0.1), adapt_delta = 0.999, data = magnitudedata)
               

c_bayes <- pairs(emmeans(fit_bayes, ~ heading))
c_bayes
```

## Construcing hypothesis restriction

```{r hypothesis for restriction}
hyp <- c("2 < 1.5 & 1.5 < 1 & 1 < 0.5")
```


## Restriction model for contr.sum model

```{r contr.sum restriction}

posteriors <- insight::get_parameters(fit_sum)

em_sum <- emmeans(fit_sum, ~ heading)
em_sum # the posterior marginal means

bayesfactor_restricted(em_sum, fit_sum, hypothesis = hyp)
```

## Restriction model for contr.bayes model

```{r contr.bayes restriction}
bayes_sum <- emmeans(fit_bayes, ~ heading)
bayes_sum # the posterior marginal means

bayesfactor_restricted(bayes_sum, fit_bayes, hypothesis = hyp)
```
