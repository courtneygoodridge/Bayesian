---
title: "Bayesian_restriction"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The aim of this markdown file

This markdown details a description of how to implement a restriction model. The original model comes from the easy stats website (https://easystats.github.io/bayestestR/articles/bayes_factors.html#specifying-correct-priors-for-factors-with-more-than-2-levels) however I had issues with implementing my own example.

After reporting an issue with the bayestestR team, it become clear that there is a bug when trying to implement restriction models with a Gamma distribution. One of the package creates helped me formulate a solution around this bug, and this markdown details that solution.

## Load packages 

```{r load packages, message =FALSE}
library(dplyr) # data manipulation
library(tidyr) # data manipulation
library(ggplot2) # data vis
library(BayesFactor) # performs Bayesian ANOVA
library(rstanarm) # bayesian regression modelling
library(bayestestR) # describes Bayesian models and posterior distributions
library(bayesplot) # allows plots for posterior predictive distributions
library(loo) # Bayesian model comparison
library(arm) # computes Bayes factor for glm model
library(insight) # get posterior parameters 
library(fitdistrplus) # investigating the distribution of my data
library(see) # helps with plotting for bayestestR package
library(emmeans) # marginal mean from Bayesian model
```

## Load my data and data used in the example

```{r load my data}
# rm(list = ls()) - clear global environment
# home working directory
# setwd("C:/Users/Courtney/Documents/PhD/Project/Experiment_Code/experiment_1")
setwd("C:/Users/pscmgo/OneDrive for Business/PhD/Project/Experiment_Code/experiment_1")
temp = list.files(pattern = c("magnitudedata", "*.csv"))
myfiles = lapply(temp, read.csv)
magnitudedata <- do.call(rbind.data.frame, myfiles)
```

## Setting heading levels as factors and setting contrasts

```{r factors}
magnitudedata <- magnitudedata %>%
  dplyr::filter(heading > 0)

magnitudedata$heading <- as.factor(magnitudedata$heading)

```

Here I remove the 0 heading condition and change my predictor variable to a factor. 

## Fitting Bayesian model for contr.bayes contrast

```{r contr.bayes model fit}
contrasts(magnitudedata$heading) <- "contr.bayes"

fit_bayes <- stan_glm(FirstSteeringTime ~ heading,
                      family = Gamma(link ="identity"),
                      adapt_delta = 0.999,
                      data = magnitudedata)
```

I change the contrast setting to *contr.bayes*. Doing this allows for better informed priors when dealing with 3 or more factor levels. It essentially ensures that each prior for every contrast is equal. Otherwise when it comes to the posterior distributions, a contrast with a slightly different prior will be biased and thus the Bayes factor will be altered. 

## Generate estimated marginal means for each heading from the fitted model

```{r estimated marginal means}
bayes_sum <- emmeans(fit_bayes, ~ heading)
bayes_sum
```
The *emmeans* function calculates the estimated margin means based upon the Bayesian model fit.

## Creating a prior model is get around a bug in the bayestestR package

```{r prior model implementation}
fit_bayes_prior <- update(fit_bayes, prior_PD = TRUE)
bayes_sum_prior <- emmeans(fit_bayes_prior, ~ heading)
```

First I update the model and set *prior_PD* as TRUE. This generates samples from the prior distributions for my parameters (i.e. the levels of my heading factor). This means that the *fit_bayes_prior* object is the same as the *fit_bayes* - it just draws from the prior distribution rather than the posterior distribution.

The *bayes_sum_prior* object is then the estimated marginal means based upon the prior Bayesian model fit. 

## Setting the hypotheses for the restriction model

```{r hypothesis}
hyp <- c("`2` < `1.5` & `1.5` < `1` & `1` < `0.5`")
```

If parameters are numbers, they need to be surrounded by back ticks when formulating the hypothesis. 

## Calculating Bayes factor for restriction model

```{r restriction Bayes}
bayesfactor_restricted(posterior = bayes_sum,
                       prior = bayes_sum_prior,
                       hypothesis = hyp)
```

I pass my prior estimates model for my priors arguement (as it is calculated from draws of the prior distributuon) and the orignal model as my posterior argument. Hence with both prior and posteriors set, I can compute a Bayes factor (the degree of change from prior to posterior odds) based on my hypothesis.

This reveals that the current data is 61.54 times more likely under the restriction model than under the un-restricted model. 

## Fitting Bayesian model for contr.sum contrasts

```{r contr.sum contrasts}
contrasts(magnitudedata$heading) <- "contr.sum"

fit_sum <- stan_glm(FirstSteeringTime ~ heading,
                       family = Gamma(link = "identity"),
                       adapt_delta = 0.999,
                       data = magnitudedata)

c_sum <- pairs(emmeans(fit_sum, ~ heading))
c_sum
```

## Fitting Bayesian model for contr.bayes contrasts

```{r contr.bayes contrasts}
contrasts(magnitudedata$heading) <- "contr.bayes"

fit_bayes <- stan_glm(FirstSteeringTime ~ heading, family = gaussian(), prior = cauchy(0.5, 0.1), adapt_delta = 0.999, data = magnitudedata)
               

c_bayes <- pairs(emmeans(fit_bayes, ~ heading))
c_bayes
```

## Construcing hypothesis restriction

```{r hypothesis for restriction}
hyp <- c("2 < 1.5 & 1.5 < 1 & 1 < 0.5")
```


## Restriction model for contr.sum model

```{r contr.sum restriction}

posteriors <- insight::get_parameters(fit_sum)

em_sum <- emmeans(fit_sum, ~ heading)
em_sum # the posterior marginal means

bayesfactor_restricted(em_sum, fit_sum, hypothesis = hyp)
```

## Restriction model for contr.bayes model

```{r contr.bayes restriction}
bayes_sum <- emmeans(fit_bayes, ~ heading)
bayes_sum # the posterior marginal means

bayesfactor_restricted(bayes_sum, fit_bayes, hypothesis = hyp)
```
