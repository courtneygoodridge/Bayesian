---
title: "Bayesian_Factorial_ANOVA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Aim of this markdown

The aim of this markdown is to implement a Bayesian factorial ANOVA in prepartion for analysis of my experiment 2 data. I will be using data from the *ToothGrowth* package. I will also be comparing this analysis to the Frequentist alternative.

## Load packages 

```{r load packages, message = FALSE}
# rm(list = ls()) - clear global environment
library(dplyr) # data manipulation
library(tidyr) # data manipulation
library(ggplot2) # data vis
library(BayesFactor) # performs Bayesian ANOVA
library(rstanarm) # bayesian regression modelling
library(bayestestR) # describes Bayesian models and posterior distributions
library(bayesplot) # allows plots for posterior predictive distributions
library(loo) # Bayesian model comparison
library(arm) # computes Bayes factor for glm model
library(insight) # get posterior parameters 
library(fitdistrplus) # investigating the distribution of my data
library(see) # helps with plotting for bayestestR package
library(emmeans) # marginal mean from Bayesian model
library(sjstats) # computes partial eta squared effect size
library(effsize) # computes cohen's D for follow up t-tests
library(Rmisc) # for confidence intervals on the interaction plots
library(lsr) # for calculating effect size 
```

## Load example data 

```{r cars}
data("ToothGrowth")
View(ToothGrowth)
```

The following data set is from an experiment with a 3 x 2 factorial design. The outcome varible is tooth length (*len*), one factor is supplement type (*vitamin C (VC) or orange juice (OJ)*) and the other is the dose of the supplement (*0.5, 1.0 and 2.0*).

Are there main effect of supplement and dose on tooth growth, and do the two interact? Firstly, lets analysis the data using frequentist methods.

## Summary statistics

```{r summary statistics}
ToothGrowth %>%
  dplyr::group_by(supp, dose) %>%
  dplyr::summarise(m = mean(len))
```

Summary statistics show that as dose increases, tooth length increases. This is the case for supplements.

# Interaction plots

```{r interaction plot with confidence intervals}
# computes standard error and 95% confidence intervals
CIerror_bar <- summarySE(ToothGrowth, measurevar = "len", groupvars = c("supp", "dose"))

ggplot(data = CIerror_bar, aes(x = dose, color = supp, group = supp, y = len)) +
         stat_summary(fun.y = mean, geom = "point") +
         stat_summary(fun.y = mean, geom = "line") +
  geom_errorbar(aes(ymin = len - se, ymax = len + se), width = .1) +
  geom_point(data = ToothGrowth, aes(x = dose, y = len), alpha = 0.5) +
  ylab("Tooth length (mm)") +
  xlab("Dosage (mg)")
```

They appears to be a clear main effect of dose (as dose increases tooth length increases) and supplement (orange juice appears to provide increase tooth length). The interaction is less obvious. This I implement a 3x2 factorial ANOVA to investigate these effects. 

## Two way factorial ANOVA (frequentist)

```{r frequentist ANOVA}
ToothGrowth$dose <- as.factor(ToothGrowth$dose)

aov.result <- aov(len ~ supp * dose, data = ToothGrowth)
plot(aov.result, 2)

summary(aov.result)
etaSquared(aov.result)
```
The Q-Q plot plots theoretical quantiles agaist the standardised residuals to visualise normality. This plot appears to indicate that the residuals are normally distributed, thus the normality assumption of the ANOVA has not been violated. 

The 3x2 ANOVA reveals the following:

- A significant main effect of supplement with a medium effect size [f(1,56) = 12.32, p = 0.0008, eta^2 = 0.06]. Because there are only two levels, I can say that orange juice significantly improves tooth growth versus vitamin C. 

- A significant main effect of dose with a large effect size [f(1,56) = 133.42, p < 0.0001, eta^2 = 0.64]. This will need post hoc analyses to investigate. 

- A significant interaction between dose and supplement with a small effect size [f(1,56) = 5.33, p = 0.02, eta^2 = 0.03].

Thus with this interaction, I then perform post hoc comparisons to investigate this difference.

## Post hoc analyses of significant interaction

```{r tukeyHSD}
TukeyHSD(aov.result)
```

Tukey's HSD reveals that the main effect of dose comes about via the higher the dose, the bigger the increase in tooth growth.

The interaction of dose and supplement comes about via orange juice providing larger increases in tooth growth as the dose increases, however for the highest doses there was no difference in between orange juice and vitamin C. 

## Conclusions so far

Thus far, frequentist methods have revealed significnat main effects of dose and supplement. They have also revealed that the effect of dose significantly depends on the supplement - i.e. orange juice provides larger growth in small doses, but there is no difference in tooth growth between the supplements for the maximum doses. 

These conclusions are fair, and the correct analyses and corrections have been implemented. How do this compare with Bayesian equivalents?

## Fitting Bayesian model - first way

```{r fitting Bayesian model}
fit_model <- stan_glm(len ~ supp * dose,
                      family = gaussian(link = "identity"),
                      adapt_delta = 0.999,
                      data = ToothGrowth)

fit_model
```

Here I fit a generalised linear model with gaussian family and identity link function because the residuals of this data are normally distributed. I fit this model using the normal formula notation which generates main effects of supplement and dose and a supplement x dose interaction. 

# Fitting Bayesian model - stan example 

```{r fitting Bayesian model - stan example}
post1 <- stan_glm(len ~ 1, data = ToothGrowth, 
                  family = gaussian(link = "identity"), 
                  adapt_delta = 0.999)
post2 <- update(post1, formula = . ~ supp)
post3 <- update(post1, formula = . ~ dose)
post4 <- update(post1, formula = . ~ supp + dose)
(post5 <- update(post1, formula = . ~ supp * dose))
```

This example is taken and adapted from here (http://mc-stan.org/rstanarm/articles/continuous.html#model-comparison). Here I fit a series of models:

- an intercept only model (when supplement and dose are 0, what is ToothGrowth length)
- one for each predictor variable (supplement and dose)
- the two predictors combined
- the interacton between the two predictors

I fit one model at a time and update the model based upon the new formula. The benefit of this method is that I can use the "loo" package to perform a model comparison. This provides extra information regarding how which predictors predict the data and how they do so. 

```{r Bayes facot comparison per model}
comparison <- bayesfactor_models(post2, post3, post4, post5, denominator = post1)
comparison

```

## Model comparison

```{r model comparison}
# Compare them with loo
loo1 <- loo(post1, cores = 2)
loo2 <- loo(post2, cores = 2)
loo3 <- loo(post3, cores = 2)
loo4 <- loo(post4, cores = 2)
(comp <- loo_compare(loo1, loo2, loo3, loo4))
```